FROM ubuntu:22.04

#Install build tools and dependencies
RUN apt-get update && apt-get install -y \
    g++ cmake make git \
    libgtest-dev libpthread-stubs0-dev \
    && apt-get clean

#Build GoogleTest (since Ubuntu provides only the source)
RUN mkdir /gtest_build && cd /gtest_build && \
    cmake /usr/src/googletest && \
    make && \
    cp ./lib/*.a /usr/lib/

#Set the working directory
WORKDIR /app

#Copy the entire project
COPY . .

#Compile only the server_client_tests.cpp test
RUN g++ -std=c++17 -Wall \
    -Isrc/BloomFilter -Isrc/server -Isrc \
    tests/server/server_client_tests.cpp \
    src/BloomFilter/BloomFilter.cpp \
    src/BloomFilter/BlackList.cpp \
    src/BloomFilter/url.cpp \
    src/server/server.cpp \
    src/server/SessionHandler.cpp \
    src/server/CommandManager.cpp \
    /usr/lib/libgtest.a -pthread -o test_runner

#Run the test binary
CMD ["./test_runner"]